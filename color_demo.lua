-- global
GRAVITY = 0.75
FRICTION = 0.75
AIR = 0.90
MAX_SEED = 6
t=0

-- animations --
idle_animation = {
	id = 256,
	num = 8,
	speed = 16,
	counter = 0,
	w = 2,
	h = 2,
	loop = 1,
}
run_animation = {
	id = 288,
	num = 8,
	speed = 6,
	counter = 0,
	w = 2,
	h = 2,
	loop = 1,
}
jump_animation = {
	id = 320,
	num = 2,
	speed = 4,
	counter = 0,
	w = 2,
	h = 2,
	loop = 1,
}
fall_animation = {
	id = 324,
	num = 4,
	speed = 4,
	counter = 0,
	w = 2,
	h = 2,
	loop = 0,
}

jump2_animation = {
	id = 352,
	num = 6,
	speed = 2,
	counter = 0,
	w = 2,
	h = 2,
	loop = 0,
}
test_animation = {
	id = 32,
	num = 1,
	speed = 4,
	counter = 0,
	w = 2,
	h = 2,
	loop = 0,
}

player = {
	x = 98,
	y = 24,
	w = 16,
	h = 16,
	dx = 0,
	dy = 0,
	s = 2,
    j = 6,
    on_ground = false,
	anim = idle_animation,
	state = "idle",
	counter = 0,
	flip = 0,
    jumps = 0,
    max_jumps = 2,
}

function TIC()
	cls()
	map(0,0,30,17,0,0,-1,1)

	update_player()
    player.counter = draw_object(player)
	--print("dx = " .. player.dx .. ", dy = " .. player.dy, 0, 0)
	t=t+1
end


function player_input()
	-- movement --
	if (btnp(0) or btnp(4)) and 
    player.jumps < player.max_jumps then
        player.jumps = player.jumps + 1
		player.dy = -player.j 
	end
    ---if btn(0) then player.dy = -player.s end
	if btn(1) then player.dy = player.s end
	if btn(2) then player.dx = -player.s end
	if btn(3) then player.dx = player.s end
end

function player_states()
	local new_state = ""

	if player.on_ground == false then
        if player.dy > 1 then 
            new_state = "fall"
        elseif player.jumps > 1 then
            new_state = "double_jump"
        else
		    new_state = "jump"
        end
    elseif player.on_ground == true then
        player.jumps = 0    
        if player.dx == 0 then
            new_state = "idle"
        elseif player.dx ~= 0 then
            new_state = "run"
        end
    end

	if player.state ~= new_state then
        player.counter = 0
        player.state = new_state
		if new_state == "idle" then
			player.anim = idle_animation
		elseif new_state == "run" then
			player.anim = run_animation
		elseif new_state == "jump" then
			player.anim = jump_animation
        elseif new_state == "fall" then
            player.anim = fall_animation
        elseif new_state == "double_jump" then
            player.anim = jump2_animation
        end
	end

	if player.dx < 0 then
		player.flip = 1
	elseif player.dx > 0 then
		player.flip = 0
	end

end


function update_player()
    player_input()
	gravity(player)

	collision_x(player)
	player.x = player.x + player.dx
	collision_y(player)
	player.y = player.y + player.dy

    player_states()

end

function draw_object(obj)
	if t % obj.anim.speed == 0 then
		obj.counter = obj.counter + 1
		if obj.anim.loop == 1 then
			obj.counter = obj.counter % obj.anim.num
		elseif obj.counter > obj.anim.num -1 then
			obj.counter = obj.anim.num -1
		end
	end
	
	local offset_rows = math.floor(obj.anim.id/(16 * obj.anim.h))
	local offset_cols = (obj.anim.id - (offset_rows * 16 * obj.anim.h)) / obj.anim.w
	local offset = offset_rows * 8 + offset_cols
	local sprite_id = ((obj.counter + offset) * obj.anim.w) % 16 + math.floor((obj.counter +offset) * obj.anim.w / 16) * 16 * obj.anim.h
	spr(sprite_id, player.x, player.y, 0, 1, player.flip, 0, obj.anim.w, obj.anim.h)
	return obj.counter
end

-- gravity --
function gravity(obj)
    if obj.on_ground == false then
        obj.dy = obj.dy + GRAVITY
        if obj.dy > 7 then
            obj.dy = 7
        end
		if obj.dx > 0 then
			obj.dx = math.floor(10*obj.dx * AIR)/10
		elseif obj.dx < 0 then
			obj.dx = math.ceil(10*obj.dx * AIR)/10
		end
    else
		if obj.dx > 0 then
			obj.dx = math.floor(10*obj.dx * FRICTION)/10
		elseif obj.dx < 0 then
			obj.dx = math.ceil(10*obj.dx * FRICTION)/10
		end
	end

end

-- collisions --
function getMidpoint(p1, p2)
  local midX = math.floor((p1.x + p2.x) / 2)
  local midY = math.floor((p1.y + p2.y) / 2)
  return {x = midX, y = midY}
end

ox = 4
function collision_x(obj)
    -- x axis --
    local top_left  = {x = (obj.x - 1 + ox + obj.dx),      y = (obj.y)}
    local top_right = {x = (obj.x + obj.w - ox + obj.dx),  y = (obj.y)}
    local bot_left  = {x = (obj.x - 1 + ox + obj.dx),      y = (obj.y + obj.h - 1)}
    local bot_right = {x = (obj.x + obj.w - ox + obj.dx),  y = (obj.y + obj.h - 1)}
    local mid_left  = getMidpoint(top_left,  bot_left)
    local mid_right = getMidpoint(top_right, bot_right)

    if fget(mget(top_left.x/8, top_left.y/8),0) or
       fget(mget(mid_left.x/8, mid_left.y/8),0) or
       fget(mget(bot_left.x/8, bot_left.y/8),0) then
        if obj.dx < 0 then
		    obj.dx = math.ceil(top_left.x/8)*8 - (obj.x + ox)
        end
    end

    if fget(mget(top_right.x/8, top_right.y/8),0) or
       fget(mget(mid_right.x/8, mid_right.y/8),0) or
       fget(mget(bot_right.x/8, bot_right.y/8),0) then
        if obj.dx > 0 then
            obj.dx = math.floor((top_right.x)/8)*8 - (obj.x + obj.w - ox)
        end
    end
end

function collision_y(obj)
    -- y axis --
    local top_left  = {x = (obj.x + ox),      		 y = (obj.y - 1 + obj.dy)}
    local top_right = {x = (obj.x + obj.w -1 - ox),  y = (obj.y - 1 + obj.dy)}
    local bot_left  = {x = (obj.x + ox),      	     y = (obj.y + obj.h + obj.dy)}
    local bot_right = {x = (obj.x + obj.w -1 - ox),  y = (obj.y + obj.h + obj.dy)}
    local top_mid   = getMidpoint(top_left, top_right)
    local bot_mid   = getMidpoint(bot_left, bot_right)

    if fget(mget(top_left.x/8,  top_left.y/8),0) or
       fget(mget(top_mid.x/8,   top_mid.y/8),0) or
       fget(mget(top_right.x/8, top_right.y/8),0) then
        if obj.dy < 0 then
		    obj.dy = math.ceil(top_mid.y/8)*8 - (obj.y)
        end
    end

    if (fget(mget(bot_left.x/8,  bot_left.y/8),0) or
       fget(mget(bot_mid.x/8,   bot_mid.y/8),0) or
       fget(mget(bot_right.x/8, bot_right.y/8),0)) then
		player.on_ground = true
		if obj.dy > 0 then
            obj.dy = math.floor(bot_mid.y/8)*8 - (obj.y + obj.h)
        end
	else
		player.on_ground = false
	end
end

-- <TILES>
-- 000:5555555555555555555555555555555555555555555555555555555555555555
-- 001:4424443434243444442444442222222244444244434442434434424422222222
-- 002:7777777778787878888888887878787888888888888888888788878888888888
-- 018:8888888888878888888888888888888888888888888888788788888888888888
-- 032:00cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede
-- 033:cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede00
-- 034:cdcdcdcddedededecdcdcdcddedededecdcdcdcddedededecdcdcdcddededede
-- 035:cdcdcdcddedededecdcdcdcddedededecdcdcdcddedededecdcdcdcddededede
-- 048:00cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede
-- 049:cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede00
-- 050:cdcdcdcddedededecdcdcdcddedededecdcdcdcddedededecdcdcdcddededede
-- 051:cdcdcdcddedededecdcdcdcddedededecdcdcdcddedededecdcdcdcddededede
-- </TILES>

-- <SPRITES>
-- 000:0000000000000006000000660000006600000006000007cc000077cc000070cc
-- 001:0000000060000000660000006600000060000000c0000000cc000000c1000000
-- 002:000000000000000600000066000000660000000600000000000007cc000077cc
-- 003:000000006000000066000000660000006000000000000000cc000000c1000000
-- 004:000000000000000000000006000000660000006600000006000000000000077c
-- 005:00000000000000006000000066000000660000006000000000000000cc000000
-- 006:000000000000000000000000000000060000006600000066000000060000077c
-- 007:00000000000000000000000060000000660000006600000060000000cc000000
-- 008:000000000000000000000000000000060000006600000066000000060000077c
-- 009:00000000000000000000000060000000660000006600000060000000cc000000
-- 010:000000000000000000000006000000660000006600000006000000000000077c
-- 011:00000000000000006000000066000000660000006000000000000000cc000000
-- 012:000000000000000600000066000000660000000600000000000007cc000077cc
-- 013:000000006000000066000000660000006000000000000000cc000000c1000000
-- 014:0000000000000006000000660000006600000006000007cc000077cc000070cc
-- 015:0000000060000000660000006600000060000000c0000000cc000000c1000000
-- 016:000090ee00009aee00009aae00000aa00000aa000000a000000aa000000a0000
-- 017:e1e00000e0e00000eeee0000eee000000ee0000000e0000000e0000000e00000
-- 018:000090ec00009eee00009aae00000aa00000aa000000a000000aa000000a0000
-- 019:c1000000e0e00000eeee0000eee000000ee0000000e0000000e0000000e00000
-- 020:000077cc000090ec00009aae00000aaa0000aaa00000aa00000aa000000a0000
-- 021:c1000000c0100000e00e0000ee0000000ee0000000e0000000e0000000e00000
-- 022:000077cc000090cc00009eee00009aae0000aaa00000aa000000a000000aa000
-- 023:c1000000c1100000e0ee0000ee0e0000eee0000000e0000000e0000000e00000
-- 024:000077cc000090cc00009eee00009aae0000aaa00000aa000000a000000aa000
-- 025:c1000000c1100000e0ee0000ee0e0000eee0000000e0000000e0000000e00000
-- 026:000077cc000090ec00009aae00000aaa0000aaa00000aa00000aa000000a0000
-- 027:c1000000c0100000e00e0000ee0000000ee0000000e0000000e0000000e00000
-- 028:000090ec00009eee00009aae00000aa00000aa000000a000000aa000000a0000
-- 029:c1000000e0e00000eeee0000eee000000ee0000000e0000000e0000000e00000
-- 030:000090ee00009aee00009aae00000aa00000aa000000a000000aa000000a0000
-- 031:e1e00000e0e00000eeee0000eee000000ee0000000e0000000e0000000e00000
-- 032:0000000000000006000000060000000000000000000001170000e1c70000e0ce
-- 033:6600000066600000666000006600000000000000cc0000007c00000070090000
-- 034:00000000000000000000000000000000000000000000000c0000007c0000077c
-- 035:0000000000000000066000006666000066660000c6600000cc000000cc000000
-- 036:0000000000000000000000000000000000000000000000cc000077ec00097ecc
-- 037:0000000006600000666600006666000006600000c0000000c0000000c1e00000
-- 038:00000000000000000000000000000000000997000099077c009900ec000000ee
-- 039:0660000066660000666600000660000000000000cc000e00cc10ee00e001e000
-- 040:00000000000000000000000000000000000000000000077c000077ec000900ec
-- 041:0660000066660000666600000660000000000000cc000000cc100000c01ee000
-- 042:00000000000000000000000000000000000000000000000c00000777000077ee
-- 043:0000000000000000066000006666000066660000c6600000cc000000cc000000
-- 044:00000000000000000000000000000000000000000000000c000001c7000011e7
-- 045:0000000006600000666600006666000006600000cc000000cc000000cc000000
-- 046:000000000000000600000006000000000000e000000ee1c700ee00c7000000ce
-- 047:66000000666000006660000066000000000900007c09000077990000e7900000
-- 048:000ee0ee00000eee00000aaa0000aaaaaaaaaa00a00000000000000000000000
-- 049:79990000e0000000ae000000eee0000000ee000000ee0000000e0000000e0000
-- 050:000007ee0000099900000aa9000000aa00000aaa00000aee000000ee000000ee
-- 051:e0000000ee00000000000000a0000000a0000000000000000000000000000000
-- 052:009900ee00990eaa00000eaa0000ee00000ee00000ee00000ee000000ee00000
-- 053:e0ee0000aaa00000aaaa000000aa0000000a0000000000000000000000000000
-- 054:000000ee00000eaa0000eeea0eeeeee00e000000000000000000000000000000
-- 055:e0000000aaa00000aaaa0000000aa0000000aa000000a0000000000000000000
-- 056:009900ee00000aaa00000eaa0eeeeeea000ee000000000000000000000000000
-- 057:e0000000a0000000aa000000aaa000000aa0000000a0000000a0000000aa0000
-- 058:000090ee0000999e0000099a00000aaa00000aae00000a0000000a000000aa00
-- 059:e0000000e0000000ee000000eee00000ee000000000000000000000000000000
-- 060:000ee0e7000ee0aa00000aaa0000aaa0000aaa0000aa00000aa0000000a00000
-- 061:70000000999e0000eeee0000000e0000000ee000000000000000000000000000
-- 062:000000ee00000aaa0000aaaa000aaaa0aaaaa000a00000000000000000000000
-- 063:e0000000ee000000eee000000eee0000000ee0000000ee000000000000000000
-- 064:0000000000000006000000060000000000000007000000770000077e00007700
-- 065:66000000666000006660000066000000ccc00000ccc70000ccc70000eee77000
-- 066:000000060000006600000066000000060000007c0000077c000077ec0000700e
-- 067:60000000660000006600000060000000c7000000cc700000cc770000cc077000
-- 068:000000060000006600000066000000060000077c0000777c000770ec0007700e
-- 069:60000000660000006600000060000000c7700000cc770000cc007000ee077000
-- 070:00000006000000660000006600077006007777cc077007cc00000eec000000ee
-- 071:60000000660000006600000060700000c7770000c7077000c0000000eee00000
-- 072:00000006000000660000006600777006077077cc007007cc00000eec000000ee
-- 073:60000000660000006600000060700000c7777000c7007000c0000000eee00000
-- 074:00000006000000660000006600777006077077cc000007cc00000eec000000ee
-- 075:60000000660000006600000067770000c7000000c7000000c0000000eee00000
-- 080:000077000000770a0000070a0000000a000000aa000000aa00000aa000000aa0
-- 081:eee07700aeee0700aaeee000a00ee00000ee00000ee000000e00000000000000
-- 082:0000700e000070aa000000aa000000aa000000aa000000a000000aa000000a00
-- 083:ee077000eee00000aeeee00000ee00000ee00000ee000000e000000000000000
-- 084:0000700e000000aa0000000a0000000a0000000a000000aa0000000000000000
-- 085:ee000000aeee0000aaee0000aaee0000ae000000e00000000000000000000000
-- 086:000000ea000000aa000000aa0000000a0000000a0000000a0000000000000000
-- 087:aee00000aae00000aee00000ae0000000e000000000000000000000000000000
-- 088:000000aa000000aa0000000a0000000a0000000a0000000a0000000000000000
-- 089:eee00000aee00000ae000000ae000000a0000000000000000000000000000000
-- 090:000000ee000000aa000000aa000000aa000000a0000000a0000000a0000000a0
-- 091:eee00000ee000000ee000000e000000000000000000000000000000000000000
-- 096:00000000000000000000009000000097000007770000e7770000eeec0000eeec
-- 097:000000000000000066000000666000006660000066100000c0000000c0000000
-- 098:0000000000000000000000000000000000000ccc000eaecc0000aaec0000aaae
-- 099:00000000000000000000000000000000cc000000ccc66000ce66660077966600
-- 100:0000000000000000000e000000eee00a00e0ccca00000cca000000cc00000000
-- 101:0aa0000000a00000aa000000a0000000aa000000aaa00000aeec0000eeee0000
-- 102:00000000000000000000aaa000000aa0000000aa000000aa0001100a0766110a
-- 103:000000000000000000e0000000ee00000ce00000acc00000aac00000aac00000
-- 104:0000000000000000000000000006600000666600006666cc00077ccc07777ecc
-- 105:0000000000000000000000000000000000000000000aaaa0c0aa0000ccaacc00
-- 106:000000000000000000000066000006660000066600077e6607777ecc97000ecc
-- 107:000000000000000000000000600000006100000010110000c00ee000c0000000
-- 112:0000eecc0000aaac00000aaa0000000a0000000a0000000a0000000000000000
-- 113:cc000000cccc0000aee0000000e0000000000000000000000000000000000000
-- 114:00aaaa000000aa00000000000000000000000000000000000000000000000000
-- 115:7996610077711000700100000000000000000000000000000000000000000000
-- 116:0000077700001777000017970000099600000666000000660000000000000000
-- 117:ceee00007eee00007ee000006000000060000000000000000000000000000000
-- 118:077661ce97776cce09077eee0000eeee00000000000000000000000000000000
-- 119:aaa00000eac00000ee000000e000000000000000000000000000000000000000
-- 120:970001ec9000001e00000ee00000000000000000000000000000000000000000
-- 121:caaacceeeaaa000e000000000000000000000000000000000000000000000000
-- 122:090000ec000000ee0000000a0000000a000000ee000000e00000000000000000
-- 123:e0000000ac000000acc00000acc00000aa0000000aa000000aa000000a000000
-- </SPRITES>

-- <MAP>
-- 001:000000000000000000001010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:000000001010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:000000001010101000000000000000000000000000000000000000000000000000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:000000000000000000000000000000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:000000000000000000000000000000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:000000000000000000000000000000000000000000000000000000000000000000000000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:000000000000000000000000000000000000000010101010000000000000000000000000001010000000000000000000000010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:000000000000000000000000000000000000000010101010000000000000000010100000000000000000000000000000000010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:000000000000000010000000000000001010101010101010101000000000000000000000000000000000000000001010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:000000000000000010000000000000001010101010101010101000000000000000000000000000000000000000001010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:202020202020202020202020202020202020202020202020202020202020101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:212121212121212121212121212121212121212121212121212121212121101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <TRACKS>
-- 000:100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </TRACKS>

-- <FLAGS>
-- 000:00101000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:3200115f3a60876672b7a39dece8c26db7c35e80b26270578da24ed2cb3ef7d554e8bf92e78c5bc66f5ec33846933942
-- </PALETTE>
