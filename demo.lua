-- global
GRAVITY = 1
FRICTION = 0.75
MAX_SEED = 6
t=0

-- animations --
idle_animation = {
	id = 256,
	num = 8,
	speed = 16,
	counter = 0,
	w = 2,
	h = 2,
	loop = 1,
}
run_animation = {
	id = 288,
	num = 8,
	speed = 6,
	counter = 0,
	w = 2,
	h = 2,
	loop = 1,
}
jump_animation = {
	id = 320,
	num = 6,
	speed = 4,
	counter = 0,
	w = 2,
	h = 2,
	loop = 0,
}
jump2_animation = {
	id = 352,
	num = 6,
	speed = 4,
	counter = 0,
	w = 2,
	h = 2,
	loop = 0,
}
test_animation = {
	id = 32,
	num = 1,
	speed = 4,
	counter = 0,
	w = 2,
	h = 2,
	loop = 0,
}

player = {
	x = 98,
	y = 24,
	w = 16,
	h = 16,
	dx = 0,
	dy = 0,
	s = 2,
    j = 6,
    on_ground = false,
	anim = idle_animation,
	state = "idle",
	counter = 0,
	flip = 0,
}

function TIC()
	cls()
	map(0,0,30,17,0,0,-1,1)

	update_player()
    player.counter = draw_object(player)
	print("dx = " .. player.dx .. ", dy = " .. player.dy, 0, 0)

	t=t+1
end


function player_input()
	-- movement --
	if (btnp(0) or btnp(4)) and player.on_ground == true then 
		player.dy = -player.j 
	end
    ---if btn(0) then player.dy = -player.s end
	if btn(1) then player.dy = player.s end
	if btn(2) then player.dx = -player.s end
	if btn(3) then player.dx = player.s end
end

function player_states()
	local new_state = ""
	if player.dy ~= 0 or player.on_ground == false then
		new_state = "jump"
    elseif player.dx == 0 then
		new_state = "idle"
    elseif player.dx ~= 0 then
		new_state = "run"
    end

	if player.state ~= new_state then
		if new_state == "idle" then
			player.counter = 0
			player.anim = idle_animation
			player.state = "idle"
		elseif new_state == "run" then
			player.counter = 0
			player.anim = run_animation
			player.state = "run"
		elseif new_state == "jump" then
			player.counter = 0
			player.anim = jump_animation
			player.state = "jump"
		end
	end

	if player.dx < 0 then
		player.flip = 1
	elseif player.dx > 0 then
		player.flip = 0
	end

end


function update_player()
    player_input()
	gravity(player)
    player_states()

	collision_x(player)
	player.x = player.x + player.dx
	collision_y(player)
	player.y = player.y + player.dy

end

function draw_object(obj)
	if t % obj.anim.speed == 0 then
		obj.counter = obj.counter + 1
		if obj.anim.loop == 1 then
			obj.counter = obj.counter % obj.anim.num
		elseif obj.counter > obj.anim.num -1 then
			obj.counter = obj.anim.num -1
		end
	end
	
	local offset_rows = math.floor(obj.anim.id/(16 * obj.anim.h))
	local offset_cols = (obj.anim.id - (offset_rows * 16 * obj.anim.h)) / obj.anim.w
	local offset = offset_rows * 8 + offset_cols
	local sprite_id = ((obj.counter + offset) * obj.anim.w) % 16 + math.floor((obj.counter +offset) * obj.anim.w / 16) * 16 * obj.anim.h
	spr(sprite_id, player.x, player.y, 0, 1, player.flip, 0, obj.anim.w, obj.anim.h)
	return obj.counter
end

-- gravity --
function gravity(obj)
    if obj.on_ground == false then
        obj.dy = obj.dy + GRAVITY
        if obj.dy > 7 then
            obj.dy = 7
        end
    else
		if obj.dx > 0 then
			obj.dx = math.floor(10*obj.dx * FRICTION)/10
		elseif obj.dx < 0 then
			obj.dx = math.ceil(10*obj.dx * FRICTION)/10
		end
	end

end

-- collisions --
function getMidpoint(p1, p2)
  local midX = math.floor((p1.x + p2.x) / 2)
  local midY = math.floor((p1.y + p2.y) / 2)
  return {x = midX, y = midY}
end

ox = 4
function collision_x(obj)
    -- x axis --
    local top_left  = {x = (obj.x - 1 + ox + obj.dx),      y = (obj.y)}
    local top_right = {x = (obj.x + obj.w - ox + obj.dx),  y = (obj.y)}
    local bot_left  = {x = (obj.x - 1 + ox + obj.dx),      y = (obj.y + obj.h - 1)}
    local bot_right = {x = (obj.x + obj.w - ox + obj.dx),  y = (obj.y + obj.h - 1)}
    local mid_left  = getMidpoint(top_left,  bot_left)
    local mid_right = getMidpoint(top_right, bot_right)

    if fget(mget(top_left.x/8, top_left.y/8),0) or
       fget(mget(mid_left.x/8, mid_left.y/8),0) or
       fget(mget(bot_left.x/8, bot_left.y/8),0) then
		obj.dx = math.ceil(top_left.x/8)*8 - (obj.x + ox)
    end

    if fget(mget(top_right.x/8, top_right.y/8),0) or
       fget(mget(mid_right.x/8, mid_right.y/8),0) or
       fget(mget(bot_right.x/8, bot_right.y/8),0) then
        obj.dx = math.floor((top_right.x)/8)*8 - (obj.x + obj.w - ox)
    end
end

function collision_y(obj)
    -- y axis --
    local top_left  = {x = (obj.x + ox),      		 y = (obj.y - 1 + obj.dy)}
    local top_right = {x = (obj.x + obj.w -1 - ox),  y = (obj.y - 1 + obj.dy)}
    local bot_left  = {x = (obj.x + ox),      	     y = (obj.y + obj.h + obj.dy)}
    local bot_right = {x = (obj.x + obj.w -1 - ox),  y = (obj.y + obj.h + obj.dy)}
    local top_mid   = getMidpoint(top_left, top_right)
    local bot_mid   = getMidpoint(bot_left, bot_right)

    if fget(mget(top_left.x/8,  top_left.y/8),0) or
       fget(mget(top_mid.x/8,   top_mid.y/8),0) or
       fget(mget(top_right.x/8, top_right.y/8),0) then
		obj.dy = math.ceil(top_mid.y/8)*8 - (obj.y)
    end

    if fget(mget(bot_left.x/8,  bot_left.y/8),0) or
       fget(mget(bot_mid.x/8,   bot_mid.y/8),0) or
       fget(mget(bot_right.x/8, bot_right.y/8),0) then
		player.on_ground = true
		obj.dy = math.floor(bot_mid.y/8)*8 - (obj.y + obj.h)
	else
		player.on_ground = false
	end
end

-- <TILES>
-- 000:aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
-- 001:55e555d5d5e5d55555e55555eeeeeeee55555e555d555e5d55d55e55eeeeeeee
-- 032:00cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede
-- 033:cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede00
-- 034:cdcdcdcddedededecdcdcdcddedededecdcdcdcddedededecdcdcdcddededede
-- 035:cdcdcdcddedededecdcdcdcddedededecdcdcdcddedededecdcdcdcddededede
-- 048:00cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede
-- 049:cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede00cdcdcd00dedede00
-- 050:cdcdcdcddedededecdcdcdcddedededecdcdcdcddedededecdcdcdcddededede
-- 051:cdcdcdcddedededecdcdcdcddedededecdcdcdcddedededecdcdcdcddededede
-- </TILES>

-- <SPRITES>
-- 000:000000000000000b000000bb000000bb0000000b000006330000663300006033
-- 001:00000000b0000000bb000000bb000000b0000000300000003300000031000000
-- 002:000000000000000b000000bb000000bb0000000b000000000000063300006633
-- 003:00000000b0000000bb000000bb000000b0000000000000003300000031000000
-- 004:00000000000000000000000b000000bb000000bb0000000b0000000000000663
-- 005:0000000000000000b0000000bb000000bb000000b00000000000000033000000
-- 006:0000000000000000000000000000000b000000bb000000bb0000000b00000663
-- 007:000000000000000000000000b0000000bb000000bb000000b000000033000000
-- 008:0000000000000000000000000000000b000000bb000000bb0000000b00000663
-- 009:000000000000000000000000b0000000bb000000bb000000b000000033000000
-- 010:00000000000000000000000b000000bb000000bb0000000b0000000000000663
-- 011:0000000000000000b0000000bb000000bb000000b00000000000000033000000
-- 012:000000000000000b000000bb000000bb0000000b000000000000063300006633
-- 013:00000000b0000000bb000000bb000000b0000000000000003300000031000000
-- 014:000000000000000b000000bb000000bb0000000b000006330000663300006033
-- 015:00000000b0000000bb000000bb000000b0000000300000003300000031000000
-- 016:0000502200005422000054420000044000004400000040000004400000040000
-- 017:2120000020200000222200002220000002200000002000000020000000200000
-- 018:0000502300005222000054420000044000004400000040000004400000040000
-- 019:3100000020200000222200002220000002200000002000000020000000200000
-- 020:0000663300005023000054420000044400004440000044000004400000040000
-- 021:3100000030100000200200002200000002200000002000000020000000200000
-- 022:0000663300005033000052220000544200004440000044000000400000044000
-- 023:3100000031100000202200002202000022200000002000000020000000200000
-- 024:0000663300005033000052220000544200004440000044000000400000044000
-- 025:3100000031100000202200002202000022200000002000000020000000200000
-- 026:0000663300005023000054420000044400004440000044000004400000040000
-- 027:3100000030100000200200002200000002200000002000000020000000200000
-- 028:0000502300005222000054420000044000004400000040000004400000040000
-- 029:3100000020200000222200002220000002200000002000000020000000200000
-- 030:0000502200005422000054420000044000004400000040000004400000040000
-- 031:2120000020200000222200002220000002200000002000000020000000200000
-- 032:000000000000000b0000000b0000000000000000000001160000213600002032
-- 033:bb000000bbb00000bbb00000bb00000000000000330000006300000060050000
-- 034:0000000000000000000000000000000000000000000000030000006300000663
-- 035:00000000000000000bb00000bbbb0000bbbb00003bb000003300000033000000
-- 036:0000000000000000000000000000000000000000000000330000662300056233
-- 037:000000000bb00000bbbb0000bbbb00000bb00000300000003000000031200000
-- 038:0000000000000000000000000000000000055600005506630055002300000022
-- 039:0bb00000bbbb0000bbbb00000bb0000000000000330002003310220020012000
-- 040:0000000000000000000000000000000000000000000006630000662300050023
-- 041:0bb00000bbbb0000bbbb00000bb0000000000000330000003310000030122000
-- 042:0000000000000000000000000000000000000000000000030000066600006622
-- 043:00000000000000000bb00000bbbb0000bbbb00003bb000003300000033000000
-- 044:0000000000000000000000000000000000000000000000030000013600001126
-- 045:000000000bb00000bbbb0000bbbb00000bb00000330000003300000033000000
-- 046:000000000000000b0000000b0000000000002000000221360022003600000032
-- 047:bb000000bbb00000bbb00000bb00000000050000630500006655000026500000
-- 048:0002202200000222000004440000444444444400400000000000000000000000
-- 049:6555000020000000420000002220000000220000002200000002000000020000
-- 050:0000062200000555000004450000004400000444000004220000002200000022
-- 051:2000000022000000000000004000000040000000000000000000000000000000
-- 052:0055002200550244000002440000220000022000002200000220000002200000
-- 053:2022000044400000444400000044000000040000000000000000000000000000
-- 054:0000002200000244000022240222222002000000000000000000000000000000
-- 055:2000000044400000444400000004400000004400000040000000000000000000
-- 056:0055002200000444000002440222222400022000000000000000000000000000
-- 057:2000000040000000440000004440000004400000004000000040000000440000
-- 058:0000502200005552000005540000044400000442000004000000040000004400
-- 059:2000000020000000220000002220000022000000000000000000000000000000
-- 060:0002202600022044000004440000444000044400004400000440000000400000
-- 061:6000000055520000222200000002000000022000000000000000000000000000
-- 062:0000002200000444000044440004444044444000400000000000000000000000
-- 063:2000000022000000222000000222000000022000000022000000000000000000
-- 064:000000000000000b0000000b0000000000000006000000660000066200006600
-- 065:bb000000bbb00000bbb00000bb00000033300000333e0000333e0000222ee000
-- 066:0000000b000000bb000000bb0000000b00000063000006630000662300006002
-- 067:b0000000bb000000bb000000b00000003e00000033e0000033ee0000330ee000
-- 068:0000000b000000bb000000bb0000000b00000663000066630006602300066002
-- 069:b0000000bb000000bb000000b00000003ee0000033ee00003300e000220ee000
-- 070:0000000b000000bb000000bb0006600b00666633066006330000022300000022
-- 071:b0000000bb000000bb000000b0e000003eee00003e0ee0003000000022200000
-- 072:0000000b000000bb000000bb0066600b06606633006006330000022300000022
-- 073:b0000000bb000000bb000000b0e000003eeee0003e00e0003000000022200000
-- 074:0000000b000000bb000000bb0066600b06606633000006330000022300000022
-- 075:b0000000bb000000bb000000beee00003e0000003e0000003000000022200000
-- 080:0000660000006604000006040000000400000044000000440000044000000440
-- 081:2220ee0042220e00442220004002200000220000022000000200000000000000
-- 082:0000600200006044000000440000004400000044000000400000044000000400
-- 083:220ee00022200000422220000022000002200000220000002000000000000000
-- 084:0000600200000044000000040000000400000004000000440000000000000000
-- 085:2200000042220000442200004422000042000000200000000000000000000000
-- 086:0000002400000044000000440000000400000004000000040000000000000000
-- 087:4220000044200000422000004200000002000000000000000000000000000000
-- 088:0000004400000044000000040000000400000004000000040000000000000000
-- 089:2220000042200000420000004200000040000000000000000000000000000000
-- 090:0000002200000044000000440000004400000040000000400000004000000040
-- 091:2220000022000000220000002000000000000000000000000000000000000000
-- 096:0000000000000000000000500000005600000666000026660000222300002223
-- 097:0000000000000000bb000000bbb00000bbb00000bb1000003000000030000000
-- 098:0000000000000000000000000000000000000333000242330000442300004442
-- 099:0000000000000000000000000000000033000000333bb00032bbbb00665bbb00
-- 100:0000000000000000000200000022200400203334000003340000003300000000
-- 101:0440000000400000440000004000000044000000444000004223000022220000
-- 102:0000000000000000000044400000044000000044000000440001100406bb1104
-- 103:0000000000000000002000000022000003200000433000004430000044300000
-- 104:000000000000000000000000000bb00000bbbb0000bbbb330006633306666233
-- 105:0000000000000000000000000000000000000000000444403044000033443300
-- 106:0000000000000000000000bb00000bbb00000bbb000662bb0666623356000233
-- 107:000000000000000000000000b0000000b1000000101100003002200030000000
-- 112:0000223300004443000004440000000400000004000000040000000000000000
-- 113:3300000033330000422000000020000000000000000000000000000000000000
-- 114:0044440000004400000000000000000000000000000000000000000000000000
-- 115:655bb10066611000600100000000000000000000000000000000000000000000
-- 116:0000066600001666000016560000055b00000bbb000000bb0000000000000000
-- 117:322200006222000062200000b0000000b0000000000000000000000000000000
-- 118:066bb1325666b332050662220000222200000000000000000000000000000000
-- 119:4440000024300000220000002000000000000000000000000000000000000000
-- 120:5600012350000012000002200000000000000000000000000000000000000000
-- 121:3444332224440002000000000000000000000000000000000000000000000000
-- 122:0500002300000022000000040000000400000022000000200000000000000000
-- 123:2000000043000000433000004330000044000000044000000440000004000000
-- </SPRITES>

-- <MAP>
-- 001:000000000000000000001010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:000000001010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:000000001010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:000000000000000000000000000000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:000000000000000000000000000000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:000000000000000000000000000000000000000010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:000000000000000000000000000000000000000010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:000000000000000010000000000000001010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:000000000000000010000000000000001010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <TRACKS>
-- 000:100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </TRACKS>

-- <FLAGS>
-- 000:00100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

