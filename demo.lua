-- global
GRAVITY = 1
t=0

player = {
	x = 96,
	y = 24,
	w = 16,
	h = 16,
	dx = 0,
	dy = 0,
	s = 2,
    j = 7,
    on_ground = false,
    c = 0,
    f = 0,
    a = 256,
    an = 4,
    as = 16,
}

function TIC()
	cls()
	map(0,0,30,17,0,0,-1,1)

	update_player()
	--spr(256,player.x,player.y,-1,1,0,0,1,1)

    player.c = draw_player(player.a,player.an,player.as,2,2,player.c,t)
	t=t+1
end


function player_input()
	-- movement --
	if btnp(0) then player.dy = -player.j end
	if btn(1) then player.dy = player.dy + player.s end
	if btn(2) then player.dx = player.dx - player.s end
	if btn(3) then player.dx = player.dx + player.s end
end

function player_states()
        if player.dx == 0 then
        player.a = 256
        player.an = 8
        player.as = 16
    elseif player.dx > 0 then
        player.f = 0
        player.a = 288
        player.an = 8
        player.as = 6
    elseif player.dx < 0 then
        player.f = 1
        player.a = 288
        player.an = 8
        player.as = 6
    end
end

function update_player()
    player_input()
    player_states()

    gravity(player)
    check_collision_x(player)
    check_collision_y(player)

    player.x = player.x + player.dx
    player.y = player.y + player.dy
    player.dx = 0
    --player.dy = 0

end


-- drawing --
function draw_player(start_id, animation_count, animation_speed, animation_width, animation_height, counter, t)
	if t % animation_speed == 0 then
		counter = ((counter + 1) % animation_count)
	end
	local offset = start_id / (animation_width * animation_height)
	local sprite_id = ((counter + offset) * animation_width) % 16 + math.floor((counter +offset) * animation_width / 16) * 16 * animation_height
	spr(sprite_id, player.x, player.y, 0, 1, player.f, 0, animation_width, animation_height)
    print(sprite_id)
	return counter
end

-- gravity --
function gravity(obj)
    if obj.on_ground == false then
        obj.dy = obj.dy + GRAVITY
        if obj.dy > 6 then
            obj.dy = 6
        end
    end

end

-- collisions --
function check_collision_x(obj)
    if obj.dx > 0 then
        local tr = mget((obj.x + obj.dx + obj.w)/8, (obj.y)/8)
        local br = mget((obj.x + obj.dx + obj.w)/8, (obj.y + obj.h - 1)/8)
        if fget(tr,0) or fget(br,0) then
            obj.dx = (math.floor((obj.x + obj.dx + obj.w)/8)*8) - (obj.x + obj.w)
        end
    elseif obj.dx < 0 then
        local tl = mget((obj.x + obj.dx - 1)/8, (obj.y)/8)
        local bl = mget((obj.x + obj.dx - 1)/8, (obj.y + obj.h - 1)/8)
        if fget(tl,0) or fget(bl,0) then
            obj.dx = (math.ceil((obj.x + obj.dx - 1)/8)*8) - (obj.x)
        end
    end
end

function check_collision_y(obj)
    obj.on_ground = false
    if obj.dy >= 0 then
        local bl = mget((obj.x)/8, (obj.y + obj.dy + obj.h)/8)
        local br = mget((obj.x + obj.w - 1)/8, (obj.y + obj.dy + obj.h)/8)
        if fget(bl,0) or fget(br,0) then
            obj.dy = (math.floor((obj.y + obj.dy + obj.h)/8)*8) - (obj.y + obj.h)
            obj.on_ground = true
        end
    elseif obj.dy < 0 then
        local tl = mget((obj.x)/8, (obj.y + obj.dy - 1)/8)
        local tr = mget((obj.x + obj.w - 1)/8, (obj.y + obj.dy - 1)/8)
        if fget(tl,0) or fget(tr,0) then
            obj.dy = (math.ceil((obj.y + obj.dy - 1)/8)*8) - (obj.y)
        end
        --obj.on_ground = false
    end

    
end

-- <TILES>
-- 000:aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
-- 001:ddedddddddedddddddedddddeeeeeeeedddddedddddddedddddddeddeeeeeeee
-- </TILES>

-- <SPRITES>
-- 000:000000000000000b000000bb000000bb0000000b000006330000663300006033
-- 001:00000000b0000000bb000000bb000000b0000000300000003300000031000000
-- 002:000000000000000b000000bb000000bb0000000b000000000000063300006633
-- 003:00000000b0000000bb000000bb000000b0000000000000003300000031000000
-- 004:00000000000000000000000b000000bb000000bb0000000b0000000000000663
-- 005:0000000000000000b0000000bb000000bb000000b00000000000000033000000
-- 006:0000000000000000000000000000000b000000bb000000bb0000000b00000663
-- 007:000000000000000000000000b0000000bb000000bb000000b000000033000000
-- 008:0000000000000000000000000000000b000000bb000000bb0000000b00000663
-- 009:000000000000000000000000b0000000bb000000bb000000b000000033000000
-- 010:00000000000000000000000b000000bb000000bb0000000b0000000000000663
-- 011:0000000000000000b0000000bb000000bb000000b00000000000000033000000
-- 012:000000000000000b000000bb000000bb0000000b000000000000063300006633
-- 013:00000000b0000000bb000000bb000000b0000000000000003300000031000000
-- 014:000000000000000b000000bb000000bb0000000b000006330000663300006033
-- 015:00000000b0000000bb000000bb000000b0000000300000003300000031000000
-- 016:0000502200005422000054420000044000004400000040000004400000040000
-- 017:2120000020200000222200002220000002200000002000000020000000200000
-- 018:0000502300005222000054420000044000004400000040000004400000040000
-- 019:3100000020200000222200002220000002200000002000000020000000200000
-- 020:0000663300005023000054420000044400004440000044000004400000040000
-- 021:3100000030100000200200002200000002200000002000000020000000200000
-- 022:0000663300005033000052220000544200004440000044000000400000044000
-- 023:3100000031100000202200002202000022200000002000000020000000200000
-- 024:0000663300005033000052220000544200004440000044000000400000044000
-- 025:3100000031100000202200002202000022200000002000000020000000200000
-- 026:0000663300005023000054420000044400004440000044000004400000040000
-- 027:3100000030100000200200002200000002200000002000000020000000200000
-- 028:0000502300005222000054420000044000004400000040000004400000040000
-- 029:3100000020200000222200002220000002200000002000000020000000200000
-- 030:0000502200005422000054420000044000004400000040000004400000040000
-- 031:2120000020200000222200002220000002200000002000000020000000200000
-- 032:000000000000000b0000000b0000000000000000000001160000213600002032
-- 033:bb000000bbb00000bbb00000bb00000000000000330000006300000060050000
-- 034:0000000000000000000000000000000000000000000000030000006300000663
-- 035:00000000000000000bb00000bbbb0000bbbb00003bb000003300000033000000
-- 036:0000000000000000000000000000000000000000000000330000662300056233
-- 037:000000000bb00000bbbb0000bbbb00000bb00000300000003000000031200000
-- 038:0000000000000000000000000000000000055600005506630055002300000022
-- 039:0bb00000bbbb0000bbbb00000bb0000000000000330002003310220020012000
-- 040:0000000000000000000000000000000000000000000006630000662300050023
-- 041:0bb00000bbbb0000bbbb00000bb0000000000000330000003310000030122000
-- 042:0000000000000000000000000000000000000000000000030000066600006622
-- 043:00000000000000000bb00000bbbb0000bbbb00003bb000003300000033000000
-- 044:0000000000000000000000000000000000000000000000030000013600001126
-- 045:000000000bb00000bbbb0000bbbb00000bb00000330000003300000033000000
-- 046:000000000000000b0000000b0000000000002000000221360022003600000032
-- 047:bb000000bbb00000bbb00000bb00000000050000630500006655000026500000
-- 048:0002202200000222000004440000444444444400400000000000000000000000
-- 049:6555000020000000420000002220000000220000002200000002000000020000
-- 050:0000062200000555000004450000004400000444000004220000002200000022
-- 051:2000000022000000000000004000000040000000000000000000000000000000
-- 052:0055002200550244000002440000220000022000002200000220000002200000
-- 053:2022000044400000444400000044000000040000000000000000000000000000
-- 054:0000002200000244000022240222222002000000000000000000000000000000
-- 055:2000000044400000444400000004400000004400000040000000000000000000
-- 056:0055002200000444000002440222222400022000000000000000000000000000
-- 057:2000000040000000440000004440000004400000004000000040000000440000
-- 058:0000502200005552000005540000044400000442000004000000040000004400
-- 059:2000000020000000220000002220000022000000000000000000000000000000
-- 060:0002202600022044000004440000444000044400004400000440000000400000
-- 061:6000000055520000222200000002000000022000000000000000000000000000
-- 062:0000002200000444000044440004444044444000400000000000000000000000
-- 063:2000000022000000222000000222000000022000000022000000000000000000
-- </SPRITES>

-- <MAP>
-- 005:000000001010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:000000001010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:000000000000000000000000000000000000000010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:000000000000000000000000000000000000000010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:000000000000000000000000000000001010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:000000000000000000000000000000001010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <TRACKS>
-- 000:100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </TRACKS>

-- <FLAGS>
-- 000:00100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

