-- global
GRAVITY = 1
FRICTION = 0.75
t=0

-- animations --
idle_animation = {
	id = 256,
	num = 8,
	speed = 16,
	counter = 0,
	w = 2,
	h = 2,
	loop = 1,
}

run_animation = {
	id = 288,
	num = 8,
	speed = 6,
	counter = 0,
	w = 2,
	h = 2,
	loop = 1,
}

jump_animation = {
	id = 320,
	num = 6,
	speed = 4,
	counter = 0,
	w = 2,
	h = 2,
	loop = 0,
}

player = {
	x = 96,
	y = 24,
	w = 16,
	h = 16,
	dx = 0,
	dy = 0,
	s = 2,
    j = 7,
    on_ground = false,
	anim = idle_animation,
	state = "idle",
	counter = 0,

    c = 0,
    f = 0,
    a = 256,
    an = 4,
    as = 16,
}

function TIC()
	cls()
	map(0,0,30,17,0,0,-1,1)

	update_player()
    player.counter = draw_object(player)
	print(player.dy)

	t=t+1
end


function player_input()
	-- movement --
	if btnp(0) and player.on_ground == true then player.dy = -player.j end
	--if btn(1) then player.dy = player.s end
	if btn(2) then player.dx = -player.s end
	if btn(3) then player.dx = player.s end
end

function player_states()
	local new_state = ""
	if player.dy ~= 0 or player.on_ground == false then
		new_state = "jump"
    elseif player.dx == 0 then
		new_state = "idle"
    elseif player.dx > 0 then
		new_state = "run"
        player.f = 0
    elseif player.dx < 0 then
		new_state = "run"
        player.f = 1
    end

	if player.state ~= new_state then
		change_state(new_state)
	end
end

function change_state(state)
	if state == "idle" then
		player.counter = 0
		player.anim = idle_animation
		player.state = "idle"
	elseif state == "run" then
		player.counter = 0
		player.anim = run_animation
		player.state = "run"
	elseif state == "jump" then
		player.counter = 0
		player.anim = jump_animation
		player.state = "jump"
	end
end

function update_player()
    player_input()
    player_states()

    check_collision_x(player)
    check_collision_y(player)

    player.x = player.x + player.dx
    player.y = player.y + player.dy

	gravity(player)
end

function draw_object(obj)
	if t % obj.anim.speed == 0 then
		obj.counter = obj.counter + 1

		if obj.anim.loop == 1 then
			obj.counter = obj.counter % obj.anim.num
		elseif obj.counter > obj.anim.num -1 then
			obj.counter = obj.anim.num -1
		end
	end
	
	local offset_rows = math.floor(obj.anim.id/(16 * obj.anim.h))
	local offset_cols = (obj.anim.id - (offset_rows * 16 * obj.anim.h)) / obj.anim.w
	local offset = offset_rows * 8 + offset_cols
	--local offset = (obj.anim.id / (obj.anim.w * obj.anim.h))
	local sprite_id = ((obj.counter + offset) * obj.anim.w) % 16 + math.floor((obj.counter +offset) * obj.anim.w / 16) * 16 * obj.anim.h
	spr(sprite_id, player.x, player.y, 0, 1, player.f, 0, obj.anim.w, obj.anim.h)
	return obj.counter
end

-- gravity --
function gravity(obj)
    if obj.on_ground == false then
        obj.dy = obj.dy + GRAVITY
        if obj.dy > 7 then
            obj.dy = 7
        end
    else
		if obj.dx > 0 then
			obj.dx = math.floor(10*obj.dx * FRICTION)/10
		elseif obj.dx < 0 then
			obj.dx = math.ceil(10*obj.dx * FRICTION)/10
		end
	end

end

-- collisions --
function check_collision_x(obj)
    if obj.dx > 0 then
        local tr = mget((obj.x + obj.dx + obj.w)/8, (obj.y)/8)
        local br = mget((obj.x + obj.dx + obj.w)/8, (obj.y + obj.h - 1)/8)
        if fget(tr,0) or fget(br,0) then
            obj.dx = (math.floor((obj.x + obj.dx + obj.w)/8)*8) - (obj.x + obj.w)
        end
    elseif obj.dx < 0 then
        local tl = mget((obj.x + obj.dx - 1)/8, (obj.y)/8)
        local bl = mget((obj.x + obj.dx - 1)/8, (obj.y + obj.h - 1)/8)
        if fget(tl,0) or fget(bl,0) then
            obj.dx = (math.ceil((obj.x + obj.dx - 1)/8)*8) - (obj.x)
        end
    end
end

function check_collision_y(obj)
    obj.on_ground = false
    if obj.dy >= 0 then
        local bl = mget((obj.x)/8, (obj.y + obj.dy + obj.h)/8)
        local br = mget((obj.x + obj.w - 1)/8, (obj.y + obj.dy + obj.h)/8)
        if fget(bl,0) or fget(br,0) then
            obj.dy = (math.floor((obj.y + obj.dy + obj.h)/8)*8) - (obj.y + obj.h)
            obj.on_ground = true
        end
    elseif obj.dy < 0 then
        local tl0 = mget((obj.x)/8, (obj.y + obj.dy - 1)/8)
        local tr0 = mget((obj.x + obj.w - 1)/8, (obj.y + obj.dy - 1)/8)
        local tl1 = mget((obj.x)/8, (obj.y - 1)/8)
        local tr1 = mget((obj.x + obj.w - 1)/8, (obj.y - 1)/8)
		if fget(tl1,0) or fget(tr1,0) then
            obj.dy = (math.ceil((obj.y - 1)/8)*8) - (obj.y)
        elseif fget(tl0,0) or fget(tr0,0) then
            obj.dy = (math.ceil((obj.y + obj.dy - 1)/8)*8) - (obj.y)
        end
    end

    
end

-- <TILES>
-- 000:aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
-- 001:ddedddddddedddddddedddddeeeeeeeedddddedddddddedddddddeddeeeeeeee
-- </TILES>

-- <SPRITES>
-- 000:000000000000000b000000bb000000bb0000000b000006330000663300006033
-- 001:00000000b0000000bb000000bb000000b0000000300000003300000031000000
-- 002:000000000000000b000000bb000000bb0000000b000000000000063300006633
-- 003:00000000b0000000bb000000bb000000b0000000000000003300000031000000
-- 004:00000000000000000000000b000000bb000000bb0000000b0000000000000663
-- 005:0000000000000000b0000000bb000000bb000000b00000000000000033000000
-- 006:0000000000000000000000000000000b000000bb000000bb0000000b00000663
-- 007:000000000000000000000000b0000000bb000000bb000000b000000033000000
-- 008:0000000000000000000000000000000b000000bb000000bb0000000b00000663
-- 009:000000000000000000000000b0000000bb000000bb000000b000000033000000
-- 010:00000000000000000000000b000000bb000000bb0000000b0000000000000663
-- 011:0000000000000000b0000000bb000000bb000000b00000000000000033000000
-- 012:000000000000000b000000bb000000bb0000000b000000000000063300006633
-- 013:00000000b0000000bb000000bb000000b0000000000000003300000031000000
-- 014:000000000000000b000000bb000000bb0000000b000006330000663300006033
-- 015:00000000b0000000bb000000bb000000b0000000300000003300000031000000
-- 016:0000502200005422000054420000044000004400000040000004400000040000
-- 017:2120000020200000222200002220000002200000002000000020000000200000
-- 018:0000502300005222000054420000044000004400000040000004400000040000
-- 019:3100000020200000222200002220000002200000002000000020000000200000
-- 020:0000663300005023000054420000044400004440000044000004400000040000
-- 021:3100000030100000200200002200000002200000002000000020000000200000
-- 022:0000663300005033000052220000544200004440000044000000400000044000
-- 023:3100000031100000202200002202000022200000002000000020000000200000
-- 024:0000663300005033000052220000544200004440000044000000400000044000
-- 025:3100000031100000202200002202000022200000002000000020000000200000
-- 026:0000663300005023000054420000044400004440000044000004400000040000
-- 027:3100000030100000200200002200000002200000002000000020000000200000
-- 028:0000502300005222000054420000044000004400000040000004400000040000
-- 029:3100000020200000222200002220000002200000002000000020000000200000
-- 030:0000502200005422000054420000044000004400000040000004400000040000
-- 031:2120000020200000222200002220000002200000002000000020000000200000
-- 032:000000000000000b0000000b0000000000000000000001160000213600002032
-- 033:bb000000bbb00000bbb00000bb00000000000000330000006300000060050000
-- 034:0000000000000000000000000000000000000000000000030000006300000663
-- 035:00000000000000000bb00000bbbb0000bbbb00003bb000003300000033000000
-- 036:0000000000000000000000000000000000000000000000330000662300056233
-- 037:000000000bb00000bbbb0000bbbb00000bb00000300000003000000031200000
-- 038:0000000000000000000000000000000000055600005506630055002300000022
-- 039:0bb00000bbbb0000bbbb00000bb0000000000000330002003310220020012000
-- 040:0000000000000000000000000000000000000000000006630000662300050023
-- 041:0bb00000bbbb0000bbbb00000bb0000000000000330000003310000030122000
-- 042:0000000000000000000000000000000000000000000000030000066600006622
-- 043:00000000000000000bb00000bbbb0000bbbb00003bb000003300000033000000
-- 044:0000000000000000000000000000000000000000000000030000013600001126
-- 045:000000000bb00000bbbb0000bbbb00000bb00000330000003300000033000000
-- 046:000000000000000b0000000b0000000000002000000221360022003600000032
-- 047:bb000000bbb00000bbb00000bb00000000050000630500006655000026500000
-- 048:0002202200000222000004440000444444444400400000000000000000000000
-- 049:6555000020000000420000002220000000220000002200000002000000020000
-- 050:0000062200000555000004450000004400000444000004220000002200000022
-- 051:2000000022000000000000004000000040000000000000000000000000000000
-- 052:0055002200550244000002440000220000022000002200000220000002200000
-- 053:2022000044400000444400000044000000040000000000000000000000000000
-- 054:0000002200000244000022240222222002000000000000000000000000000000
-- 055:2000000044400000444400000004400000004400000040000000000000000000
-- 056:0055002200000444000002440222222400022000000000000000000000000000
-- 057:2000000040000000440000004440000004400000004000000040000000440000
-- 058:0000502200005552000005540000044400000442000004000000040000004400
-- 059:2000000020000000220000002220000022000000000000000000000000000000
-- 060:0002202600022044000004440000444000044400004400000440000000400000
-- 061:6000000055520000222200000002000000022000000000000000000000000000
-- 062:0000002200000444000044440004444044444000400000000000000000000000
-- 063:2000000022000000222000000222000000022000000022000000000000000000
-- 064:000000000000000b0000000b0000000000000006000000660000066200006600
-- 065:bb000000bbb00000bbb00000bb00000033300000333e0000333e0000222ee000
-- 066:0000000b000000bb000000bb0000000b00000063000006630000662300006002
-- 067:b0000000bb000000bb000000b00000003e00000033e0000033ee0000330ee000
-- 068:0000000b000000bb000000bb0000000b00000663000066630006602300066002
-- 069:b0000000bb000000bb000000b00000003ee0000033ee00003300e000220ee000
-- 070:0000000b000000bb000000bb0006600b00666633066006330000022300000022
-- 071:b0000000bb000000bb000000b0e000003eee00003e0ee0003000000022200000
-- 072:0000000b000000bb000000bb0066600b06606633006006330000022300000022
-- 073:b0000000bb000000bb000000b0e000003eeee0003e00e0003000000022200000
-- 074:0000000b000000bb000000bb0066600b06606633000006330000022300000022
-- 075:b0000000bb000000bb000000beee00003e0000003e0000003000000022200000
-- 080:0000660000006604000006040000000400000044000000440000044000000440
-- 081:2220ee0042220e00442220004002200000220000022000000200000000000000
-- 082:0000600200006044000000440000004400000044000000400000044000000400
-- 083:220ee00022200000422220000022000002200000220000002000000000000000
-- 084:0000600200000044000000040000000400000004000000440000000000000000
-- 085:2200000042220000442200004422000042000000200000000000000000000000
-- 086:0000002400000044000000440000000400000004000000040000000000000000
-- 087:4220000044200000422000004200000002000000000000000000000000000000
-- 088:0000004400000044000000040000000400000004000000040000000000000000
-- 089:2220000042200000420000004200000040000000000000000000000000000000
-- 090:0000002200000044000000440000004400000040000000400000004000000040
-- 091:2220000022000000220000002000000000000000000000000000000000000000
-- 096:0000000000000000000000000000002200000222000022020000000200000002
-- 098:0000000000000000000022220000000000000000000000000000000200000022
-- 099:0000000000000000200000002000000020000000200000000000000000000000
-- 100:0000000000000000000002200000000200000000000000000000000000000000
-- 101:0000000000000000000000002000000002000000200000002000000022000000
-- 102:0000000000000000000000200000022000000200000002000000200200002222
-- 103:0000000000000000000000000000000000000000000000002000000020000000
-- 104:0000000000000000000000000000000200000002000000000000000000000000
-- 105:0000000000000000000000002200200000222000200000002200000002200000
-- 106:0000000000000000000000000000000000000022000022000000200000002000
-- 108:0000000000000000000000000000222200000000000000000000000000000000
-- 109:0000000000000000000000002000000002200000002000000020000000200000
-- 110:0000000000000000000000220000022000000200000002200000002200002222
-- 111:0000000000000000000000002200000002000000220000002000000022000000
-- 112:0000000200000002000000000000000000000000000000000000000000000000
-- 114:0000022000000200000002220000000000000000000000000000000000000000
-- 115:0000000000000000220000000000000000000000000000000000000000000000
-- 116:0000000000000000000002200000000200000000000000000000000000000000
-- 117:0220000002200000220000002000000000000000000000000000000000000000
-- 119:2000000020000000200000002000000000000000000000000000000000000000
-- 120:0000020000000220000000200000000200000000000000000000000000000000
-- 121:0020000000200000002000002220000000000000000000000000000000000000
-- 122:0000202200002220000002000000022200000002000000000000000000000000
-- 123:0000000020000000200000002000000020000000000000000000000000000000
-- 124:0000000000000000000000020000000000000000000000000000000000000000
-- 125:0020000000200000222200000020000002200000000000000000000000000000
-- 126:0000200000002000000022000000022000000002000000000000000000000000
-- 127:0220000000200000002000000200000020000000000000000000000000000000
-- 128:0000000000000000000022220000202200002022000022220000000200000000
-- 129:0000000000000000000000000000000000000000000000000000000020000000
-- 130:0000000000000000000000000000200000002000000020000000200000000200
-- 131:0000000000000000000000000000000022200000202200002002000020020000
-- 144:0000000000000000000020000000220200000022000000000000000000000000
-- 145:2000000020000000200000002000000000000000000000000000000000000000
-- 146:0000020000000200000002000000002000000020000000000000000000000000
-- 147:2002000020020000200200000222000000000000000000000000000000000000
-- </SPRITES>

-- <MAP>
-- 005:000000001010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:000000001010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:000000000000000000000000000000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:000000000000000000000000000000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:000000000000000000000000000000000000000010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:000000000000000000000000000000000000000010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:000000000000000000000000000000001010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:000000000000000000000000000000001010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <TRACKS>
-- 000:100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </TRACKS>

-- <FLAGS>
-- 000:00100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

